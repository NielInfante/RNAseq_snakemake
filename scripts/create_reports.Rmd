---
title: "RNA seq Report"
author: "WVU Bioinformatics Core"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=F)


# Error logging
log <- file(snakemake@log[[1]], open="wt")
sink(log)
sink(log, type="message")

# Load needed packages
library(tidyverse)
library(DESeq2)
library("RColorBrewer")
library(ggrepel)
library(gplots)
library(pheatmap)
library(knitr)
library(DT)
library(kableExtra)




# Read dds
exp <- snakemake@params$exp
dds <- readRDS(paste0("results/", exp, "/deseq/dds.rds"))

vsd <- vst(dds, blind=F)


# For testing only
#vsd <- varianceStabilizingTransformation(dds, blind=F)


# Select genes which are ost informative,
# ie those that have the biggest difference in expression
asvd <- assay(vsd)
info <- rowMax(asvd) - rowMin(asvd)
minInfo <- info[order(info, decreasing = T)][500]
vsd <- vsd[info > minInfo,]


# Read Metadata and source config
meta_file_name <- snakemake@config$metadata_file
meta <- read_tsv(meta_file_name)

#snakemake@source(paste0('../', exp, '/deseq/', 'config.R'))
source(paste0('results/', exp, '/deseq/config.R'))

# Read results
res <- read_tsv(paste0('results/', exp, '/deseq/results.txt'))
sig <- read_tsv(paste0('results/', exp, '/deseq/significant.txt'))

# Read CV
cv <- read_tsv(paste0('results/', exp, '/deseq/basemean_cutoff.txt'))
cut_value <- cv$CV[1]
max_y <- cv$MY[1]
```

## Table of Contents
<UL>
	<LI>Differential Expression Results Table
	<UL>
		<LI><a href="#(3)">Table</a>
		<LI><a href="#(4)">Explanation of Columns</a>
		<LI><a href="#(5)">Fold Change Visualization</a>
		<LI><a href="#(6)">Expression Cutoff</a>
		<LI><a href="#(7)">Significant Genes</a>
	</UL>
</UL>
<UL>
	<LI>Visualizations of Differential Expression
	<UL>
		<LI><a href="#(8)">MA Plot</a>
		<LI><a href="#(9)">Cluster</a>
		<LI><a href="#(10)">PCA</a>
		<LI><a href="#(11)">PCA with names</a>
		<LI><a href="#(12)">Volcano</a>
		<LI><a href="#(13)">Expression Heatmap</a>
	</UL>
</UL>	
<UL>
	<LI>Gene Ontology
	<UL>
		<LI><a href="#(14)">Molecular Function</a>
		<LI><a href="#(15)">Molecular Function Bar Plot</a>
		<LI><a href="#(16)">Biological Processes</a>
		<LI><a href="#(17)">Biological Processes Dot Plot</a>
		<LI><a href="#(18)">Cellular Components</a>
		<LI><a href="#(19)">Cellular Components GO Graph</a>
	</UL>
</UL>

## Results

This is the format of the results table, only 500 out of `r dim(res)[1]` genes are shown. The full list, with more columns, is available in the file results.txt.
```{r results}

tableToShow <- res %>% select(GeneName, baseMean, log2FoldChange, padj, Biotype, Cluster)

tableToShow <- tableToShow[1:500,]

tableToShow$padj <- signif(tableToShow$padj, digits=4)


#kable(res[1:5,])

datatable(tableToShow, filter='bottom', options = list(pageLength=10, lengthMenu = c(5, 10, 25))) %>% 
	formatRound('log2FoldChange', 3) %>% 
	formatRound('baseMean', 0)


```


## Explanation of Columns

```{r explain_col}

columns <- c('GeneID',
						 'GeneName',
						 'baseMean',
						 'log2FoldChange',
						 'lfcSE',
						 'stat',
						 'pvalue',
						 'padj',
						 'biotype',
						 'Sample Columns',
						 'Sample TPM',
						 'meanTPM',
						 'Cluster')

meanings <- c('Ensembl Gene ID',
							'The name of the gene',
							'Average expression of the gene across all samples',
							'log2 of the fold change of the gene',
							'Standard Error of the fold change',
							'The test statistic of the gene, used to calculate p value. Useful in some downstream analyses',
							'Unadjusted p value',
							'p value adjusted using Benjaminni-Hockberg correction',
							'The Biotype of the gene. Note that currently only one biotype is picked for each gene. Some genes may have more than one biotype',
							'Normalized counts for each sample',
							'Transcripts Pre Million for each sample',
							'Average of TPM across samples',
							'Expression cluster for filtering')

exp_col <- data.frame(Column=columns, Meaning=meanings)

kable(exp_col) %>% 
	kable_styling('striped', full_width = F) %>%
  column_spec(1, bold = F, border_right = T) %>%
  column_spec(2, width = "50em")	

```
See <a href="https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html">here</a> for a discussion of different count normalization methods, and when to choose which.

## Fold Change

```{r sanity}

title=paste(res[1,]$GeneName, "\nFold Change:",res[1,]$log2FoldChange)
plotCounts(dds, gene=res[1,]$GeneID, intgroup = PCA_Group, main=res[1,]$GeneName, 
					 sub=paste('FC:', format(res[1,]$log2FoldChange, digits=2)), pch=19)


```

Fold change is reported as log2 (Fold Change). This graph gives you an idea of what a positive versus negative fold change means.

## Expression Cutoff

```{r expr_cut}

#ggplot(res, aes(x=log2(meanTPM + 1), fill=Cluster)) + 
#	geom_density() + scale_fill_manual(values=c('#00BA38', '#F8766D'))

ggplot(res, aes(x=log2(meanTPM+1))) + geom_density() + 
	geom_vline(xintercept=cut_value, color='red') +
	geom_text(aes(x=cut_value, y=0.7 * max_y, label='   Expression Cutoff',    hjust='left'), color='red')



```

Genes are kept or excluded based on expression clustering.

```{r alt_exp_cut, eval=F}

# An alternate plot for the expression cut off

ggplot(res, aes(x=log2(meanTPM + 1), y=..count.. + 1) ) + 
	ggridges::geom_density_line( aes(fill=Cluster, color=Cluster), alpha=0.25 ) + 
	ggridges::geom_density_line( data=select(res, -Cluster) , alpha=0.25) +
	scale_color_manual(values=c('#00BA38', '#F8766D')) + 
  scale_fill_manual(values=c('#00BA38', '#F8766D')) 



```


## Significant Genes
A total of `r dim(sig)[1]` genes were counted as significant in this test. Genes are counted as significant if the adjusted p value is below 0.05, there is a fold change of at least 1.5, and they are in the high expression cluster.

The top significant genes are:

```{r significant}


tableToShow <- sig %>% select(-GeneID, -stat, -lfcSE, -pvalue)

tableToShow$padj <- signif(tableToShow$padj, digits=4)

#kable(res[1:5,])

datatable(tableToShow, filter='bottom', options = list(pageLength=10, lengthMenu = c(5, 10, 25), scrollX=T)) %>% 
	formatRound('log2FoldChange', 3) %>% 
	formatRound('baseMean', 0)


```




## MA Plot

```{r maplot}
plotMA(dds)
```

<!--  Remove this section 
## Sample Distance

```{r sample_heat}

select <- order(rowMeans(counts(dds,normalized=TRUE)),decreasing=TRUE)[1:100]
hmcol <- colorRampPalette(brewer.pal(9, "GnBu"))(100)

distsRL <- dist(t(assay(vsd)))
mat <- as.matrix(distsRL)
rownames(mat) <- colnames(mat) <- with(colData(dds), paste(Graph_Display))

heatmap.2(mat, trace="none", col = rev(hmcol), margin=c(8, 8), density.info = 'none')

```

This is a heatmap of sample distances. Dark indicates the samples are closer together, based on the expression of the 100 most expressed genes.

-->

## Cluster

```{r cluster}
plot(hclust(dist(t(assay(vsd)))), label=with(colData(dds), paste(Graph_Display)), main='Dendrogram', xlab='', sub='')

```


## PCA
```{r pca}


print(plotPCA(vsd, intgroup=c(PCA_Group)))
```

A Principle Component plot of the data. Each point is a sample.


## PCA with Names
```{r pca_names}

p <- plotPCA(vsd, intgroup=c(PCA_Group))
p <- p + geom_text_repel(aes(x=PC1, y=PC2, 
				label=with(colData(dds), paste(Graph_Display))), 
				point.padding = unit(2,"points"))
print(p)

```

The same PCA plot, with added names



##  Volcano

```{r volcano}

par(pch = 16)
with(res, plot(log2FoldChange, -log10(pvalue), main = "Volcano plot"))
with(subset(res, padj < 0.05), points(log2FoldChange, -log10(pvalue), col = "red"))
with(subset(res, abs(log2FoldChange) > 2), points(log2FoldChange, -log10(pvalue),  col = "orange"))

with(subset(res, padj < 0.05 & abs(log2FoldChange) > 2), points(log2FoldChange,  -log10(pvalue), col = "green"))

# Add legend
legend("topleft", legend = c("FDR<0.05", "|LFC|>2", "both"), pch = 16, col = c("red", "orange", "green"))

```


## Expression Heatmap

```{r pheatmap, message=F, warning=F}

rld <- rlog(dds, blind = F)

# Get 15 up, 15 down 

up <- head(order(res$log2FoldChange),15)
up <- res[up,'GeneID']


dn <- head(order(res$log2FoldChange, decreasing = T),15)
dn <- res[dn,'GeneID']

#get <- c(up,dn)
get <- c(unlist(up),unlist(dn))


rld15 <- rld[get]
#rld15 <- rld[rld@rowRanges@partitioning@NAMES %in% get, ]

rn <- data.frame(GeneID=rownames(rld15))
rn <- left_join(rn, res)

rownames(rld15) <- rn$GeneName

mat <- assay(rld15)
mat <- mat - rowMeans(mat)     # Get difference from mean for each gene
df <- as.data.frame(colData(rld15)[,PCA_Group])
names(df) <- PCA_Group

# Need the same names in both the df and the matrix
rownames(df) <- colData(rld15)[,c('Graph_Display')]
colnames(mat) <- colData(rld15)[,c('Graph_Display')]


pheatmap(mat, cutree_rows = 2, cutree_cols = 2, annotation_col = df, angle_col = "45")

```

Heatmap shows the 15 most upregulated, and 15 most downregulated genes. Color indicates how much the expression of the gene inthe samples is different from the mean expression of that gene.


## GO Analysis Molecular Function


```{r go_mf_table, message=F, warning=F}
res <- read_tsv(paste0("results/", exp, "/GO/MF_results.txt"))

if(dim(res)[1] == 0){
	print("No significant ontological terms were found for molecular function")
} else {
	res <- res %>% select(ID, Description, GeneRatio, BgRatio, p.adjust)
	datatable(res, filter='bottom', options = list(pageLength=10, lengthMenu = c(5, 10, 25), scrollX=T)) %>% 
	formatRound('p.adjust', 3)
#	formatRound('baseMean', 0)

}

```

## GO Analysis Molecular Function

```{r go_mf_plot, out.width="90%", message=F, warning=F}

res <- read_tsv(paste0("results/", exp, "/GO/MF_results.txt"))

if(dim(res)[1] == 0){
	print("No plot was created for molecular function")
} else {
	include_graphics(paste0(snakemake@scriptdir, "/../results/", exp, "/GO/MF_bar.png"))
}
```


## GO Analysis Biological Processes

```{r go_bp_table, message=F, warning=F}
res <- read_tsv(paste0("results/", exp, "/GO/BP_results.txt"))

if(dim(res)[1] == 0){
	print("No significant ontological terms were found for Biological Processes")
} else {
	res <- res %>% select(ID, Description, GeneRatio, BgRatio, p.adjust)
	datatable(res, filter='bottom', options = list(pageLength=10, lengthMenu = c(5, 10, 25), scrollX=T)) %>% 
	formatRound('p.adjust', 3)
#	formatRound('baseMean', 0)

}

```

## GO Analysis Biological Processes
```{r go_bp_plot, out.width="90%", message=F, warning=F}
res <- read_tsv(paste0("results/", exp, "/GO/BP_results.txt"))

if(dim(res)[1] == 0){
	print("No plot was created for Biological processes")
} else {
	include_graphics(paste0(snakemake@scriptdir, "/../results/", exp, "/GO/BP_dot.png"))
}


```


## GO Analysis Cellular Components

```{r go_cc_table, message=F, warning=F}
res <- read_tsv(paste0("results/", exp, "/GO/CC_results.txt"))

if(dim(res)[1] == 0){
	print("No significant ontological terms were found for Cellular Components")
} else {
	res <- res %>% select(ID, Description, GeneRatio, BgRatio, p.adjust)
	datatable(res, filter='bottom', options = list(pageLength=10, lengthMenu = c(5, 10, 25), scrollX=T)) %>% 
	formatRound('p.adjust', 3)
#	formatRound('baseMean', 0)

}

```

## GO Analysis Cellular Components
```{r go_cc_plot, out.width="95%", message=F, warning=F}
res <- read_tsv(paste0("results/", exp, "/GO/BP_results.txt"))

if(dim(res)[1] == 0){
	print("No plot was created for cellular components")
} else {
	include_graphics(paste0(snakemake@scriptdir, "/../results/", exp, "/GO/CC_GO_graph.png"))
}


```




